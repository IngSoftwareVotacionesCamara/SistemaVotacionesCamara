<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voto registrado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
    :root{
      --primary:#003366; --bg:#f4f7fb; --ink:#172033; --muted:#6b778c; --line:#d8e1ee; --white:#fff; --btn:#004884;
    }
    body{background:var(--bg); color:var(--ink)}
    .header{background:var(--primary); color:#fff; padding:12px 28px; display:flex; align-items:center; justify-content:space-between}
    .header img{height:46px}
    .card-wrap{max-width:900px; margin:36px auto}
    .card{border-radius:14px}
    .note{font-size:.95rem; color:var(--muted)}
    .btn-primary{background:var(--btn); border-color:var(--btn)}
    .btn-primary:disabled{opacity:.65}
    .btn-outline-secondary{border-color:#cfd6e4}
    .alert-success{border:1px solid #b7e1c1}
  </style>
</head>
<body>
<!-- Cinta superior -->
<div class="header">
    <div class="d-flex align-items-center gap-3">
        <img src="img/logo_cne.png" alt="CNE" />
        <div class="lh-sm">
            <div style="font-size:.95rem">Rep√∫blica de Colombia</div>
            <div class="fw-bold">Sistema de Votaci√≥n a C√°mara de Representantes</div>
        </div>
    </div>
    <div class="fw-semibold">Votaciones</div>
</div>

<div class="container card-wrap">
    <div class="card">
        <div class="card-body">
            <div class="d-flex align-items-center gap-2 mb-2">
                <span class="text-success fs-5">‚úî</span>
                <h5 class="m-0">Voto registrado</h5>
            </div>

            <p class="mb-2">Tu voto fue registrado correctamente.</p>
            <p class="note mb-3">Descarga tu certificado de votaci√≥n y, posteriormente, podr√°s salir al inicio.</p>

            <!-- S√≥lo datos del elector; nada del voto -->
            <div id="infoElector" class="small text-muted mb-3"></div>

            <div id="alertCert" class="alert alert-info py-2 px-3 mb-3">
                Debes descargar el certificado antes de poder salir.
            </div>

            <div class="d-flex gap-2">
                <button id="btnCert" class="btn btn-success">üì• Descargar certificado</button>
                <button id="btnSalir" class="btn btn-outline-secondary" disabled>Salir</button>
            </div>
        </div>
    </div>
</div>


<!-- jsPDF primero -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js" defer></script>
<!-- TU generador (el de frontend/js/certificado.js) -->
<script src="js/certificado.js?v=2" defer></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
      // ===== Estado (elector en sesi√≥n) =====
      const elector = (() => { try { return JSON.parse(sessionStorage.getItem("elector") || "null"); } catch { return null; } })();

      // Guardia: si no hay elector, vuelve al inicio
      if (!elector || !elector.id_elector) {
        window.location.replace("/");
        return;
      }

      // Pinta identidad (sin datos del voto)
      const infoElector = document.getElementById("infoElector");
      infoElector.textContent = `Elector: ${elector.nombres || ""} (ID: ${elector.id_elector || ""})`;

      // ===== UI =====
      const btnCert   = document.getElementById("btnCert");
      const btnSalir  = document.getElementById("btnSalir");
      const alertCert = document.getElementById("alertCert");

        // Descarga certificado ‚Üí habilita "Salir" (azul)
        btnCert?.addEventListener("click", async () => {
          // defensa extra: elector y funci√≥n disponibles
          if (!elector || !elector.id_elector) {
            alertCert.className = "alert alert-danger py-2 px-3 mb-3";
            alertCert.textContent = "Sesi√≥n expirada. Vuelve al inicio.";
            return;
          }
          if (typeof window.generarCertificado !== "function") {
            console.error("generarCertificado no est√° disponible (revisa js/certificado.js).");
            alertCert.className = "alert alert-danger py-2 px-3 mb-3";
            alertCert.textContent = "No se pudo generar el certificado. Recarga la p√°gina (Ctrl+F5).";
            return;
          }

          // evita clics repetidos mientras genera
          btnCert.disabled = true;

          try {
            await window.generarCertificado(elector);

            sessionStorage.setItem("cert_descargado", "1");
            alertCert.className = "alert alert-success py-2 px-3 mb-3";
            alertCert.textContent = "Certificado descargado correctamente. Ya puedes salir.";

            btnSalir.disabled = false;
            btnSalir.classList.remove("btn-outline-secondary");
            btnSalir.classList.add("btn-primary", "text-white");

            // si quieres impedir descargas duplicadas, lo dejamos deshabilitado
            // btnCert.disabled = true;
          } catch (e) {
            console.error(e);
            alertCert.className = "alert alert-danger py-2 px-3 mb-3";
            alertCert.textContent = "No se pudo generar el certificado. Intenta nuevamente.";
            // re-habilita para reintento
            btnCert.disabled = false;
          }
        });

      // Salir s√≥lo si descarg√≥ certificado
      btnSalir?.addEventListener("click", () => {
        if (sessionStorage.getItem("cert_descargado") !== "1") return;
        try { sessionStorage.removeItem("elector"); } catch {}
        window.location.replace("/");
      });

      // Si recarga la p√°gina y ya descarg√≥, mantener habilitado
      if (sessionStorage.getItem("cert_descargado") === "1") {
        btnSalir.disabled = false;
        btnSalir.classList.remove("btn-outline-secondary");
        btnSalir.classList.add("btn-primary", "text-white");
        alertCert.className = "alert alert-success py-2 px-3 mb-3";
        alertCert.textContent = "Certificado descargado correctamente. Ya puedes salir.";
        btnCert.disabled = true;
      }
    });
  </script>
</body>
</html>
