<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Votaci√≥n a C√°mara de Representantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background-color:#f4f7fb;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif}
    .header{background:#003366;color:#fff;padding:10px 30px;display:flex;align-items:center;justify-content:space-between}
    .header img{height:45px}
    .header h5{font-size:1rem;margin:0;line-height:1.2}
    .card-login{max-width:850px;margin:60px auto;background:#fff;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.1);padding:25px 30px}
    .badge-status{font-size:.9rem}
  </style>
</head>
<body>
<!-- Encabezado institucional -->
<div class="header">
  <div class="d-flex align-items-center">
    <img src="img/logo_cne.png" alt="CNE" />
    <div class="ms-3">
      <h5>Rep√∫blica de Colombia<br /><strong>Sistema de Votaci√≥n a C√°mara de Representantes</strong></h5>
    </div>
  </div>
  <div><span class="fw-semibold">Votaciones</span></div>
</div>

<!-- Cuerpo principal -->
<div class="card-login">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <span class="fw-semibold">Estado de la jornada:</span>
      <span id="badgeEstado" class="badge bg-secondary badge-status">‚Äî</span>
    </div>
    <div id="horarioJornada" class="text-muted small"></div>
  </div>

  <h5 class="mb-3">Identificaci√≥n del votante</h5>
  <form id="loginForm" class="row g-3" autocomplete="off" novalidate>
    <div class="col-md-4">
      <label for="tipo_id" class="form-label">Tipo de identificaci√≥n</label>
      <select id="tipo_id" class="form-select">
        <option selected value="CC">CC ‚Äì C√©dula</option>
        <option value="CE">CE ‚Äì C√©dula de Extranjer√≠a</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="id_elector" class="form-label">N√∫mero de identificaci√≥n</label>
      <input type="number" id="id_elector" class="form-control" placeholder="Digite su identificaci√≥n" required/>
    </div>
    <div class="col-md-4">
      <label for="password" class="form-label">Contrase√±a</label>
      <div class="input-group">
        <input type="password" id="password" class="form-control" placeholder="Digite su contrase√±a" required/>
        <button class="btn btn-outline-secondary" type="button" id="togglePassword">üëÅÔ∏è</button>
        <button class="btn btn-primary" type="submit" id="btnSubmit">Validar</button>
      </div>
    </div>
  </form>

  <div id="msg" class="mt-3"></div>
</div>
<script>
  const API_URL = "/api";

  // ===== Helpers UI =====
  function setMsg(text, kind="danger"){
    const m=document.getElementById("msg");
    m.className=`mt-3 text-${kind}`;
    m.textContent=text||"";
  }
  function disableForm(disabled=true){
    document.querySelectorAll("#loginForm input, #loginForm select, #loginForm button")
      .forEach(el=>{ el.disabled = !!disabled; });
  }
  function msToText(ms){
    if(ms<=0) return "0s";
    const s = Math.ceil(ms/1000);
    const min = Math.floor(s/60), sec = s%60;
    return min>0 ? `${min} min ${sec.toString().padStart(2,"0")} s` : `${sec} s`;
  }
  function startCountdown(ms, onFinish){
    let remaining = ms;
    setMsg(`El usuario puede votar pasados ${msToText(remaining)}.`, "warning");
    const iv = setInterval(()=>{
      remaining -= 1000;
      if(remaining <= 0){
        clearInterval(iv);
        setMsg("Ya puedes intentar ingresar nuevamente.", "success");
        disableForm(false);
        onFinish && onFinish();
        return;
      }
      setMsg(`El usuario puede votar pasados ${msToText(remaining)}.`, "warning");
    }, 1000);
  }

  // ==== Pinta horario/estado con datos del backend ====
  function paintEstadoJornada(data){
    // Badge de estado
    const badge = document.getElementById("badgeEstado");
    if(data?.abierta){
      badge.textContent = "Abierta";
      badge.className = "badge bg-success badge-status";
    }else{
      badge.textContent = "Cerrada";
      badge.className = "badge bg-danger badge-status";
    }

    // Horario (inicio/fin en es-CO)
    const el = document.getElementById("horarioJornada");
    if(el && data?.inicio && data?.fin){
      const i = new Date(data.inicio).toLocaleString("es-CO", { dateStyle:"short", timeStyle:"short" });
      const f = new Date(data.fin).toLocaleString("es-CO", { dateStyle:"short", timeStyle:"short" });
      el.textContent = `Desde ${i} hasta ${f}`;
    }
  }

  // ==== Verifica la jornada ANTES de habilitar el formulario ====
  async function checkJornada() {
    try{
      const r = await fetch("/api/estado/jornada");
      const data = await r.json();
      paintEstadoJornada(data);

      if(!data.abierta){
        // Redirige a la pantalla de votaciones cerradas
        window.location.replace("/cerrado.html");
        return false;
      }
      return true;
    }catch{
      // Si falla, no bloqueamos, pero dejamos estado desconocido
      return true;
    }
  }

  // ===== Boot =====
  window.addEventListener("DOMContentLoaded", async ()=>{
    // 1) Verificar estado de jornada
    const abierta = await checkJornada();
    if(!abierta) return; // ya redirigi√≥

    // 2) Toggle password
    const togglePassword=document.getElementById("togglePassword");
    const passwordField=document.getElementById("password");
    togglePassword?.addEventListener("click", ()=>{
      const type = passwordField.getAttribute("type")==="password" ? "text" : "password";
      passwordField.setAttribute("type", type);
      togglePassword.textContent = type==="password" ? "üëÅÔ∏è" : "üôà";
    });

    // 3) Login handler (igual que ten√≠as)
    const form   = document.getElementById("loginForm");
    const idEl   = document.getElementById("id_elector");
    const passEl = document.getElementById("password");
    const btn    = document.getElementById("btnSubmit");

    form?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      setMsg("", "danger");

      const id_elector = (idEl?.value||"").trim();
      const password   = (passEl?.value||"");
      if(!/^\d+$/.test(id_elector)){ setMsg("Documento inv√°lido."); return; }
      if(!password){ setMsg("Ingrese la contrase√±a."); return; }

      const oldTxt = btn.textContent; btn.disabled=true; btn.textContent="Validando‚Ä¶";

      try{
        // Revalida que siga abierta por si se cerr√≥ mientras tanto
        const stillOpen = await checkJornada();
        if(!stillOpen){ return; }

        const res = await fetch(`${API_URL}/login`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ id_elector, password })
        });
        const data = await res.json().catch(()=> ({}));

        // Estados especiales
        if(res.status === 409){ // EFECTUADO
          setMsg(data.message || "El elector ya registr√≥ su voto.", "warning");
          disableForm(true);
          return;
        }
        if(res.status === 423){ // BLOQUEADO
          disableForm(true);
          const remaining = Number(data.remaining_ms || 0);
          startCountdown(remaining, ()=>{ /* despu√©s del conteo, puede intentar */ });
          return;
        }

        if(!res.ok || !data?.elector?.id_elector){
          setMsg(data.message || "Credenciales inv√°lidas.");
          return;
        }

        // OK -> guardar sesi√≥n y a votar
        const payload = {
          id_elector: data.elector.id_elector,
          nombres:    data.elector.nombres,
          codigo_dane:data.elector.codigo_dane
        };
        sessionStorage.setItem("elector", JSON.stringify(payload));
        localStorage.setItem("elector_backup", JSON.stringify(payload));
        window.location.assign("/votar.html");
      }catch(err){
        console.error(err);
        setMsg("Error de conexi√≥n con el servidor.");
      }finally{
        btn.disabled=false; btn.textContent=oldTxt;
      }
    });
  });
</script>
</body>
</html>
