<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votación - Cámara de Representantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f4f7fb}
    .header{background:#003366;color:#fff;padding:12px 28px;display:flex;align-items:center;justify-content:space-between}
    .header img{height:46px}
    .card-wrap{max-width:1000px;margin:36px auto}
    .card{border-radius:14px}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border:1px solid #cfd6e4;border-radius:999px;background:#fff;cursor:pointer;font-weight:600}
    .pill input{transform:scale(1.15)}
    .pill.active{border-color:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.15)}
    .partido-card{border:2px solid transparent;border-radius:12px;padding:14px;cursor:pointer;text-align:center;background:#fff}
    .partido-card:hover{border-color:#0d6efd;background:#f0f6ff}
    .partido-card.active{border-color:#0d6efd;background:#e7f1ff}
    .blank-card{border:2px dashed #d5dced;border-radius:12px;padding:14px;background:#fcfdff;display:flex;align-items:center;justify-content:space-between}
    .muted{color:#6b778c}
    .candidate-chip .chip{
      display:inline-flex;align-items:center;justify-content:center;
      width:42px;height:42px;border-radius:50%;border:1px solid #d0d7e2;
      font-weight:600;cursor:pointer;user-select:none;
    }
  </style>
</head>
<body>

<div class="header">
  <div class="d-flex align-items-center gap-3">
    <img src="img/logo_cne.png" alt="CNE" />
    <div class="lh-sm">
      <div style="font-size:.95rem">República de Colombia</div>
      <div class="fw-bold">Sistema de Votación a Cámara de Representantes</div>
    </div>
  </div>
  <div class="fw-semibold">Votaciones</div>
</div>

<div class="container card-wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="fw-semibold">Estado de la jornada: <span class="badge bg-success">Abierta</span></div>
    <div id="horarioJornada" class="text-muted small"></div>
  </div>

  <!-- Identificación -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Identificación del votante</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Tipo de identificación</label>
          <input class="form-control" disabled value="CC – Cédula de ciudadanía">
        </div>
        <div class="col-md-6">
          <label class="form-label">Número de identificación</label>
          <input id="numIdent" class="form-control" disabled>
        </div>
      </div>
    </div>
  </div>

  <!-- Modalidad -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Modalidad de voto</h5>
      <div id="modGroup" class="d-flex flex-wrap gap-2">
        <label class="pill active"><input type="radio" name="modalidad" value="territorial" checked>Territorial</label>
        <label class="pill"><input type="radio" name="modalidad" value="afro">Afrodescendiente</label>
        <label class="pill"><input type="radio" name="modalidad" value="indigena">Indígena</label>
      </div>
    </div>
  </div>

  <!-- Selección -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="fw-bold fs-5">¿Por cuál desea votar?</div>
          <div class="muted small">Seleccione un partido o elija voto en blanco</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <input id="buscador" class="form-control form-control-sm" style="width:260px" placeholder="Buscar partido o candidato...">
          <small id="contadorResultados" class="text-muted"></small>
        </div>
      </div>

      <div class="blank-card my-3">
        <div><strong>Voto en blanco</strong><div class="muted small">Seleccione para votar en blanco</div></div>
        <input id="rbBlanco" type="radio" name="partido" class="form-check-input">
      </div>

      <div id="listaPartidos" class="row g-3"></div>
      <div id="msgSel" class="text-danger mt-2"></div>
    </div>
  </div>

  <!-- Confirmación -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">Confirmación</h5>
      <div class="mb-2"><strong>Su selección:</strong> <span id="resumenSel" class="muted">—</span></div>
      <div class="form-check mb-3">
        <input id="chkDeclaracion" class="form-check-input" type="checkbox">
        <label for="chkDeclaracion" class="form-check-label">Declaro que mi voto es personal y secreto.</label>
      </div>
      <button id="btnVotar" class="btn btn-primary px-4" disabled>Confirmar voto</button>
    </div>
  </div>
</div>

<script>
const API_URL="/api";
let elector=null;
try{elector=JSON.parse(sessionStorage.getItem("elector")||"null");}catch{}
if(!elector||!elector.id_elector){window.location="/";}
document.getElementById("numIdent").value=elector.id_elector;

const msgSel=document.getElementById("msgSel");
const listaPartidos=document.getElementById("listaPartidos");
const resumenSel=document.getElementById("resumenSel");
const btnVotar=document.getElementById("btnVotar");
const chkDeclaracion=document.getElementById("chkDeclaracion");
const rbBlanco=document.getElementById("rbBlanco");
const buscador=document.getElementById("buscador");
const contadorResultados=document.getElementById("contadorResultados");

let cod_cir=null,partidosData=[],filtro="",seleccion=null;
const candidatosCache=new Map();
const circMap={territorial:null,afro:null,indigena:null};
const circNames={territorial:"Territorial",afro:"Afrodescendiente",indigena:"Indígena"};

function saveSel(){sessionStorage.setItem("seleccion_voto",JSON.stringify(seleccion));}
function loadSel(){try{return JSON.parse(sessionStorage.getItem("seleccion_voto")||"null");}catch{return null;}}

(async function(){
  const r=await fetch(`${API_URL}/circunscripciones?codigo_dane=${elector.codigo_dane}`);
  const data=await r.json();
  for(const c of data){
    const n=c.nombre.toLowerCase();
    if(n.includes("afro"))circMap.afro=c.cod_cir;
    else if(n.includes("indig"))circMap.indigena=c.cod_cir;
    else circMap.territorial=c.cod_cir;
  }
  cod_cir=circMap.territorial;
  await cargarPartidos(cod_cir);
  const prev=loadSel();if(prev){seleccion=prev;setSeleccion(prev);}
})();

async function cargarPartidos(codCir){
  const r=await fetch(`${API_URL}/partidos?codigo_dane=${elector.codigo_dane}&cod_cir=${codCir}`);
  partidosData=await r.json();renderPartidos();
}

async function getCandidatos(codPartido){
  if(candidatosCache.has(codPartido))return candidatosCache.get(codPartido);
  const r=await fetch(`${API_URL}/candidatos?codigo_dane=${elector.codigo_dane}&cod_cir=${cod_cir}&cod_partido=${codPartido}`);
  const d=await r.json();candidatosCache.set(codPartido,d);return d;
}

function limpiarSeleccionVisual(){
  document.querySelectorAll(".partido-card").forEach(e=>e.classList.remove("active"));
  document.querySelectorAll(".chip").forEach(c=>{c.style.border="1px solid #d0d7e2";c.style.boxShadow="none";});
}

function setSeleccion(obj){
  seleccion={...obj};
  const circTxt=Object.keys(circMap).find(k=>circMap[k]===seleccion.cod_cir);
  let resumen="—";
  if(seleccion.tipo==="blanco")resumen=`Voto en blanco · Circ: ${circNames[circTxt]||"—"}`;
  else if(seleccion.tipo==="partido")resumen=`Partido ${seleccion.nombre_partido||""} · Circ: ${circNames[circTxt]||"—"}`;
  else if(seleccion.tipo==="candidato")resumen=`${seleccion.nombre_candidato||""} · Tarjetón #${seleccion.num_lista} · ${seleccion.nombre_partido||""} · Circ: ${circNames[circTxt]||"—"}`;
  resumenSel.textContent=resumen;
  btnVotar.disabled=!(chkDeclaracion.checked&&seleccion);
  saveSel();
}

async function renderPartidos(){
  listaPartidos.innerHTML="";
  const items=partidosData;
  if(!items.length){listaPartidos.innerHTML=`<div class="text-center text-secondary py-3">No hay partidos para mostrar.</div>`;return;}
  for(const p of items){
    const tipo=(p.tipo_lista||"").toUpperCase();
    const col=document.createElement("div");col.className="col-md-6";
    col.innerHTML=`
      <div class="partido-card p-3 border rounded mb-3" data-id="${p.cod_partido}">
        <div class="d-flex justify-content-between align-items-center">
          <div><div class="fw-bold">${p.nombre}</div><div class="muted small">Lista ${tipo}</div></div>
          <div><label class="form-check-label me-2 small">Votar por el partido</label><input type="radio" name="seleccion-partido" class="form-check-input"></div>
        </div><div class="mt-3 candidatos-wrap"></div></div>`;
    const card=col.querySelector(".partido-card");
    const rbPartido=col.querySelector('input[name="seleccion-partido"]');
    const candWrap=col.querySelector(".candidatos-wrap");
    rbPartido.addEventListener("change",()=>{
      limpiarSeleccionVisual();card.classList.add("active");rbBlanco.checked=false;
      setSeleccion({tipo:"partido",cod_partido:p.cod_partido,nombre_partido:p.nombre,cod_cir:cod_cir});
    });
    if(tipo==="ABIERTA"){
      const candidatos=await getCandidatos(p.cod_partido);
      candWrap.innerHTML=candidatos.map(c=>`
        <label class="candidate-chip"><input type="radio" name="sel-cand-${p.cod_partido}" class="d-none"
        data-num="${c.num_lista}" data-id="${c.id_elector}" data-nombre="${c.nombre||""}">
        <span class="chip">${c.num_lista}</span></label>`).join("");
      candWrap.querySelectorAll("input").forEach(rb=>{
        rb.addEventListener("change",()=>{
          limpiarSeleccionVisual();card.classList.add("active");
          rb.parentElement.querySelector(".chip").style.border="2px solid #0d6efd";
          setSeleccion({tipo:"candidato",cod_partido:p.cod_partido,num_lista:Number(rb.dataset.num),
            nombre_candidato:rb.dataset.nombre,nombre_partido:p.nombre,cod_cir:cod_cir});
        });
      });
    }
    listaPartidos.appendChild(col);
  }
}

rbBlanco.addEventListener("change",()=>{if(rbBlanco.checked){limpiarSeleccionVisual();setSeleccion({tipo:"blanco",cod_cir:cod_cir});}});

chkDeclaracion.addEventListener("change",()=>{btnVotar.disabled=!(chkDeclaracion.checked&&seleccion);});

btnVotar.addEventListener("click",async()=>{
  if(!seleccion){msgSel.textContent="Seleccione una opción.";return;}
  const body={
    id_elector:elector.id_elector,
    codigo_dane:elector.codigo_dane,
    cod_cir:seleccion.cod_cir,
    cod_partido:(seleccion.tipo!=="blanco")?seleccion.cod_partido:null,
    num_lista:(seleccion.tipo==="candidato")?seleccion.num_lista:null,
    voto_blanco:(seleccion.tipo==="blanco")
  };
  const r=await fetch(`${API_URL}/votar`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(r.ok){alert("✅ Voto registrado exitosamente.");window.location="/";}else msgSel.textContent="Error al registrar voto.";
});

document.querySelectorAll('input[name="modalidad"]').forEach(rb=>{
  rb.addEventListener("change",async()=>{
    document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
    rb.parentElement.classList.add("active");
    const val=rb.value;cod_cir=val==="afro"?circMap.afro:val==="indigena"?circMap.indigena:circMap.territorial;
    await cargarPartidos(cod_cir);
    const selPrev=loadSel();if(selPrev&&selPrev.cod_cir===cod_cir){seleccion=selPrev;setSeleccion(selPrev);}
  });
});
</script>
</body>
</html>
