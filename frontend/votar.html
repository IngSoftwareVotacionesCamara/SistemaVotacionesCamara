<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votaci√≥n - C√°mara de Representantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f4f7fb}
    .header{background:#003366;color:#fff;padding:12px 28px;display:flex;align-items:center;justify-content:space-between}
    .header img{height:46px}
    .card-wrap{max-width:1000px;margin:36px auto}
    .card{border-radius:14px}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border:1px solid #cfd6e4;border-radius:999px;background:#fff;cursor:pointer;font-weight:600}
    .pill input{transform:scale(1.15)}
    .pill.active{border-color:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.15)}
    .partido-card{border:2px solid transparent;border-radius:12px;padding:14px;cursor:pointer;text-align:center;background:#fff}
    .partido-card:hover{border-color:#0d6efd;background:#f0f6ff}
    .partido-card.active{border-color:#0d6efd;background:#e7f1ff}
    .blank-card{border:2px dashed #d5dced;border-radius:12px;padding:14px;background:#fcfdff;display:flex;align-items:center;justify-content:space-between}
    .muted{color:#6b778c}
    .question{font-size:1.25rem;font-weight:700;margin-bottom:6px}
    .help{font-size:.95rem}
    .badge-status{font-size:.9rem}
    .disabledish{opacity:.65;pointer-events:none}
    .partido-card.active { border-color:#0d6efd !important; box-shadow:0 0 0 2px rgba(13,110,253,.15); }
    .candidate-chip .chip {
      display:inline-flex;align-items:center;justify-content:center;
      width:42px;height:42px;border-radius:50%;border:1px solid #d0d7e2;
      font-weight:600;user-select:none;cursor:pointer;
    }
  </style>
</head>
<body>

<!-- Encabezado institucional -->
<div class="header">
  <div class="d-flex align-items-center gap-3">
    <img src="img/logo_cne.png" alt="CNE" />
    <div class="lh-sm">
      <div style="font-size:.95rem">Rep√∫blica de Colombia</div>
      <div class="fw-bold">Sistema de Votaci√≥n a C√°mara de Representantes</div>
    </div>
  </div>
  <div class="fw-semibold">Votaciones</div>
</div>

<div class="container card-wrap">
  <!-- Estado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="fw-semibold">Estado de la jornada:
      <span class="badge bg-success badge-status">Abierta</span>
    </div>
    <div id="horarioJornada" class="text-muted small"></div>
  </div>

  <!-- Bloque 1: Identificaci√≥n del votante -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Identificaci√≥n del votante</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Tipo de identificaci√≥n</label>
          <input id="tipoIdent" class="form-control" disabled value="CC ‚Äì C√©dula de ciudadan√≠a">
        </div>
        <div class="col-md-6">
          <label class="form-label">N√∫mero de identificaci√≥n</label>
          <input id="numIdent" class="form-control" disabled>
        </div>
      </div>
    </div>
  </div>

  <!-- Bloque 2: Modalidad -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Modalidad de voto</h5>
      <div id="modGroup" class="d-flex flex-wrap gap-2">
        <label class="pill" id="pill-territorial">
          <input type="radio" name="modalidad" value="territorial" class="form-check-input me-1" checked>
          Territorial
        </label>
        <label class="pill" id="pill-afro">
          <input type="radio" name="modalidad" value="afro" class="form-check-input me-1">
          Afrodescendiente
        </label>
        <label class="pill" id="pill-indigena">
          <input type="radio" name="modalidad" value="indigena" class="form-check-input me-1">
          Ind√≠gena
        </label>
      </div>
    </div>
  </div>

  <!-- Bloque 3: Selecci√≥n -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="question mb-0">¬øPor cu√°l desea votar?</div>
          <div class="help muted">Seleccione un partido o elija voto en blanco</div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <input id="buscador"
                 class="form-control form-control-sm"
                 style="width:260px"
                 placeholder="Buscar partido o candidato..." />
          <small id="contadorResultados" class="text-muted"></small>
        </div>
      </div>

      <!-- Voto en blanco -->
      <div class="blank-card my-3" id="cardBlanco">
        <div>
          <strong>Voto en blanco</strong>
          <div class="muted small">Seleccione para votar en blanco en esta circunscripci√≥n</div>
        </div>
        <input type="radio" name="partido" value="BLANCO" class="form-check-input" id="rbBlanco">
      </div>

      <!-- Lista de partidos -->
      <div id="listaPartidos" class="row g-3"></div>
      <div id="msgSel" class="text-danger mt-2"></div>
    </div>
  </div>

  <!-- Bloque 4: Confirmaci√≥n -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">Confirmaci√≥n</h5>
      <div class="mb-2"><strong>Su selecci√≥n:</strong> <span id="resumenSel" class="muted">‚Äî</span></div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="chkDeclaracion">
        <label class="form-check-label" for="chkDeclaracion">
          Declaro que mi voto es personal y secreto.
        </label>
      </div>
      <button id="btnVotar" class="btn btn-primary px-4" disabled>Confirmar voto</button>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  const API_URL = "/api";

  // === 0) Cargar o recuperar elector desde sesi√≥n ===
  let elector = null;
  try {
    elector = JSON.parse(sessionStorage.getItem("elector") || "null");
  } catch { elector = null; }

  // Si sessionStorage viene vac√≠o, intenta un respaldo en localStorage
  if (!elector || !elector.id_elector) {
    try {
      const backup = JSON.parse(localStorage.getItem("elector_backup") || "null");
      if (backup && backup.id_elector) {
        sessionStorage.setItem("elector", JSON.stringify(backup));
        elector = backup;
      }
    } catch {}
  }

  // Si a√∫n no hay sesi√≥n v√°lida ‚Üí volver al login
  if (!elector || !elector.id_elector) {
    window.location.assign("/");
  }

  // === 1) Referencias DOM ===
  const msg         = document.getElementById("msg");
  const msgSel      = document.getElementById("msgSel");
  const rbBlanco    = document.getElementById("rbBlanco");
  const listaPartidos = document.getElementById("listaPartidos");
  const resumenSel  = document.getElementById("resumenSel");
  const btnVotar    = document.getElementById("btnVotar");
  const chkDeclaracion = document.getElementById("chkDeclaracion");
  const buscador    = document.getElementById("buscador");
  const contadorResultados = document.getElementById("contadorResultados");

  // === 2) Estado global ===
  let cod_cir = null;
  let partidosData = [];
  const candidatosCache = new Map();
  let seleccion = null;
  let filtro = "";

  // Devuelve el texto de la circunscripci√≥n actual seg√∫n el radio seleccionado
  function getCircLabel() {
    const rb = document.querySelector('input[name="modalidad"]:checked');
    if (!rb) return "‚Äî";
    if (rb.value === "afro") return "Afrodescendiente";
    if (rb.value === "indigena") return "Ind√≠gena";
    return "Territorial";
  }

  // === 3) Mostrar horario de jornada ===
  (function pintarHorario(){
    const fecha = new Date();
    const fmt = { day: "2-digit", month: "2-digit", year: "numeric" };
    const dia = fecha.toLocaleDateString("es-CO", fmt);
    document.getElementById("horarioJornada").textContent =
      `Desde ${dia}, 8:00 a.m. hasta ${dia}, 4:00 p.m.`;
  })();

  // === 4) Pintar identificaci√≥n ===
  document.getElementById("numIdent").value = elector.id_elector ?? "";

  // === 5) Cargar circunscripciones ===
  const circMap = { territorial: null, afro: null, indigena: null };

  async function cargarCircunscripciones() {
    try {
      msgSel.textContent = "";
      listaPartidos.innerHTML = "";

      const res = await fetch(`${API_URL}/circunscripciones?codigo_dane=${elector.codigo_dane}`);
      const data = await res.json();

      const norm = s => (s || "")
        .normalize("NFD").replace(/\p{Diacritic}/gu, "")
        .toLowerCase().trim();

      circMap.territorial = null;
      circMap.afro        = null;
      circMap.indigena    = null;

      for (const c of data) {
        const n = norm(c.nombre);
        if (!circMap.afro && (n.includes("afro") || n.includes("comunidades negras"))) {
          circMap.afro = c.cod_cir; continue;
        }
        if (!circMap.indigena && (n.includes("indigena") || n.includes("ind√≠gena"))) {
          circMap.indigena = c.cod_cir; continue;
        }
        if (!circMap.territorial && (n.includes("territorial") || n.includes("ordinaria") || n.includes("general"))) {
          circMap.territorial = c.cod_cir;
        }
      }

      if (!circMap.territorial) {
        const resto = data.find(c => {
          const n = norm(c.nombre);
          return !n.includes("afro") && !n.includes("indigena") && !n.includes("ind√≠gena");
        });
        if (resto) circMap.territorial = resto.cod_cir;
        console.log("‚ö†Ô∏è circMap.territorial por descarte:", circMap.territorial);
      }

      // circunscripci√≥n seg√∫n el radio seleccionado
      const sel = document.querySelector('input[name="modalidad"]:checked')?.value || "territorial";
      cod_cir = sel === "afro" ? circMap.afro : sel === "indigena" ? circMap.indigena : circMap.territorial;

      document.getElementById("pill-territorial")?.classList.toggle("active", sel === "territorial");
      document.getElementById("pill-afro")?.classList.toggle("active", sel === "afro");
      document.getElementById("pill-indigena")?.classList.toggle("active", sel === "indigena");

      if (!cod_cir) {
        listaPartidos.innerHTML = `<div class="text-center text-secondary py-3">No hay partidos para esta modalidad.</div>`;
        return;
      }

      console.log("üß≠ circMap =", circMap, " | modalidad:", sel, " | cod_cir:", cod_cir);
      await cargarPartidos(cod_cir);
    } catch (e) {
      console.error(e);
      msgSel.textContent = "Error al cargar circunscripciones.";
    }
  }

  // === 6) Cargar partidos ===
  async function cargarPartidos(codCir) {
    try {
      listaPartidos.innerHTML = `<div class="text-center text-secondary py-3">Cargando partidos...</div>`;
      const res = await fetch(`${API_URL}/partidos?codigo_dane=${elector.codigo_dane}&cod_cir=${codCir}`);
      const data = await res.json();
      partidosData = Array.isArray(data) ? data : [];
      await renderPartidos();
    } catch (e) {
      console.error(e);
      msgSel.textContent = "Error al cargar partidos.";
    }
  }

  // === 7) Renderizar partidos y candidatos ===
  buscador?.addEventListener("input", async () => {
    filtro = buscador.value.trim().toLowerCase();
    await renderPartidos();
  });

  async function getCandidatos(cod_partido) {
    if (candidatosCache.has(cod_partido)) return candidatosCache.get(cod_partido);
    const res = await fetch(`${API_URL}/candidatos?codigo_dane=${elector.codigo_dane}&cod_cir=${cod_cir}&cod_partido=${cod_partido}`);
    if (res.status === 204) { candidatosCache.set(cod_partido, []); return []; }
    const data = await res.json();
    const rows = Array.isArray(data) ? data : [];
    candidatosCache.set(cod_partido, rows);
    return rows;
  }

  function limpiarSeleccionVisual() {
    document.querySelectorAll(".partido-card").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".candidate-chip .chip").forEach(ch => {
      ch.style.border = "1px solid #d0d7e2";
      ch.style.boxShadow = "none";
    });
  }

  function setSeleccion(obj) {
    // obj puede incluir: { tipo, cod_partido?, num_lista?, id_elector?, nombre_cand?, nombre_partido? }
    seleccion = obj;

    const circ = getCircLabel();

    if (seleccion?.tipo === "blanco") {
      resumenSel.textContent = `Voto en blanco ¬∑ Circ: ${circ}`;
    } else if (seleccion?.tipo === "partido") {
      // nombre del partido: si vino en obj √∫salo, si no b√∫scalo en partidosData
      const pNombre = seleccion.nombre_partido ||
        (partidosData.find(x => x.cod_partido === seleccion.cod_partido)?.nombre || "Partido");
      resumenSel.textContent = `${pNombre} (lista) ¬∑ Circ: ${circ}`;
    } else if (seleccion?.tipo === "candidato") {
      const pNombre = seleccion.nombre_partido ||
        (partidosData.find(x => x.cod_partido === seleccion.cod_partido)?.nombre || "Partido");
      const num = seleccion.num_lista ?? "‚Äî";
      const nom = seleccion.nombre_cand || ""; // si lo enviamos desde la selecci√≥n
      // Si no tenemos nombre, se muestra solo el n√∫mero
      resumenSel.textContent = nom
        ? `${pNombre} ¬∑ Tarjet√≥n #${num} ¬∑ ${nom} ¬∑ Circ: ${circ}`
        : `${pNombre} ¬∑ Tarjet√≥n #${num} ¬∑ Circ: ${circ}`;
    } else {
      resumenSel.textContent = "‚Äî";
    }

    // Habilitar/Deshabilitar Confirmar
    btnVotar.disabled = !(chkDeclaracion.checked && seleccion);
  }

  async function filtrarPartidoOCandidato(items, term) {
    if (!term) return items;
    term = term.toLowerCase();
    const out = [];
    for (const p of items) {
      const n = (p.nombre || "").toLowerCase();
      let ok = n.includes(term);
      if (!ok && (p.tipo_lista || "").toUpperCase() === "ABIERTA") {
        const candidatos = await getCandidatos(p.cod_partido);
        ok = candidatos.some(c => (String(c.num_lista || "").includes(term) || (c.nombre || "").toLowerCase().includes(term)));
      }
      if (ok) out.push(p);
    }
    return out;
  }

  async function renderPartidos() {
    listaPartidos.innerHTML = "";
    const items = await filtrarPartidoOCandidato(partidosData, filtro);

    contadorResultados.textContent = filtro
      ? (items.length ? `${items.length} resultado(s)` : "Sin coincidencias")
      : "";

    if (!items.length) {
      listaPartidos.innerHTML = `<div class="text-center text-secondary py-3">No hay partidos para mostrar.</div>`;
      return;
    }

    for (const p of items) {
      const tipo = (p.tipo_lista || "").toUpperCase();
      const col = document.createElement("div");
      col.className = "col-md-6";
      col.innerHTML = `
        <div class="partido-card p-3 border rounded mb-3" data-id="${p.cod_partido}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${p.nombre}</div>
              <div class="muted small">Lista ${tipo}</div>
            </div>
            <div>
              <label class="form-check-label me-2 small">Votar por el partido</label>
              <input type="radio" name="seleccion-partido" class="form-check-input">
            </div>
          </div>
          <div class="mt-3 candidatos-wrap"></div>
        </div>
      `;

      const card = col.querySelector(".partido-card");
      const rbPartido = col.querySelector('input[type="radio"][name="seleccion-partido"]');
      const candWrap = col.querySelector(".candidatos-wrap");

      // üëâ Siempre permitir votar por el partido (ABIERTA o CERRADA)
      rbPartido.addEventListener("change", () => {
        limpiarSeleccionVisual();
        card.classList.add("active");
        rbBlanco.checked = false;

        // Si hay candidatos pintados, al elegir el partido se desmarcan
        candWrap.querySelectorAll('input[name="seleccion-candidato"]').forEach(rb => { rb.checked = false; });

        setSeleccion({
          tipo: "partido",
          cod_partido: p.cod_partido,
          nombre_partido: p.nombre
        });
        msgSel.textContent = "";
      });

      // Si es ABIERTA ‚Üí renderizamos chips de candidatos
      if (tipo === "ABIERTA") {
        const candidatos = await getCandidatos(p.cod_partido);
        if (!candidatos.length) {
          candWrap.innerHTML = `<div class="text-muted small">Sin candidatos disponibles.</div>`;
        } else {
          candWrap.innerHTML = `
            <div class="d-flex flex-wrap gap-2">
              ${candidatos.map(c => `
                <label class="candidate-chip form-check-label" title="${c.nombre || ""}">
                  <input type="radio" name="seleccion-candidato" class="form-check-input d-none"
                         data-cod="${p.cod_partido}" data-id="${c.id_elector}" data-num="${c.num_lista}">
                  <span class="chip cand-btn">${c.num_lista}</span>
                </label>
              `).join("")}
            </div>
          `;
          candWrap.querySelectorAll('input[name="seleccion-candidato"]').forEach(rb => {
            rb.addEventListener("change", () => {
              limpiarSeleccionVisual();
              card.classList.add("active");
              const chip = rb.parentElement.querySelector(".chip");
              chip.style.border = "2px solid #0d6efd";
              chip.style.boxShadow = "0 0 0 2px rgba(13,110,253,.25)";

              rbBlanco.checked = false;
              // Al elegir candidato, desmarcar el radio de "votar por el partido" de esta tarjeta
              rbPartido.checked = false;

              setSeleccion({
                tipo: "candidato",
                cod_partido: Number(rb.dataset.cod),
                id_elector: Number(rb.dataset.id),
                num_lista: Number(rb.dataset.num),
                nombre_cand: rb.parentElement.getAttribute("title") || "", // viene del title con el nombre
                nombre_partido: p.nombre
              });
              msgSel.textContent = "";
            });
          });
        }
      }

      listaPartidos.appendChild(col);
    }
  }

  // === 8) Eventos globales ===
  rbBlanco?.addEventListener("change", () => {
    if (rbBlanco.checked) {
      limpiarSeleccionVisual();
      setSeleccion({ tipo: "blanco" });
      msgSel.textContent = "";
    }
  });

  chkDeclaracion?.addEventListener("change", () => {
    btnVotar.disabled = !(chkDeclaracion.checked && seleccion);
  });

  // === 9) Confirmar voto ===
  btnVotar?.addEventListener("click", async () => {
    if (!elector) { alert("Sesi√≥n inv√°lida"); return; }
    if (!cod_cir) { msgSel.textContent = "Seleccione una modalidad."; return; }
    if (!seleccion) { msgSel.textContent = "Seleccione un partido, un candidato o voto en blanco."; return; }
    if (!chkDeclaracion.checked) { msgSel.textContent = "Debe aceptar la declaraci√≥n."; return; }

    try {
      const body = {
        id_elector: elector.id_elector,
        codigo_dane: elector.codigo_dane,
        cod_cir,
        cod_partido: (seleccion.tipo === "partido" || seleccion.tipo === "candidato") ? seleccion.cod_partido : null,
        num_lista:   (seleccion.tipo === "candidato") ? seleccion.num_lista : null,
        voto_blanco: (seleccion.tipo === "blanco")
      };

      const res = await fetch(`${API_URL}/votar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(()=> ({}));

      if (res.ok) {
        alert("‚úÖ Voto registrado exitosamente.");
        window.location.href = "/";
      } else {
        msgSel.textContent = data.message || "No se pudo registrar el voto.";
      }
    } catch (e) {
      console.error(e);
      msgSel.textContent = "Error en la conexi√≥n con el servidor.";
    }
  });

  // === 10) Cambiar de modalidad ===
  document.querySelectorAll('input[name="modalidad"]').forEach(rb => {
    rb.addEventListener("change", async () => {
      document.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
      rb.parentElement.classList.add("active");

      const val = rb.value; // 'territorial' | 'afro' | 'indigena'
      cod_cir = val === "afro" ? circMap.afro : val === "indigena" ? circMap.indigena : circMap.territorial;

      partidosData = [];
      candidatosCache.clear();
      filtro = "";
      if (buscador) buscador.value = "";
      setSeleccion(null);

      if (!cod_cir) {
        listaPartidos.innerHTML = `<div class="text-center text-secondary py-3">No hay partidos para esta modalidad.</div>`;
        return;
      }
      await cargarPartidos(cod_cir);
    });
  });

  // === 11) Iniciar ===
  cargarCircunscripciones();
</script>

</body>
</html>
