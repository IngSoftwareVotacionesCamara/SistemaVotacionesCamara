<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votaci√≥n - C√°mara de Representantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f4f7fb}
    .header{background:#003366;color:#fff;padding:12px 28px;display:flex;align-items:center;justify-content:space-between}
    .header img{height:46px}
    .card-wrap{max-width:1000px;margin:36px auto}
    .card{border-radius:14px}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border:1px solid #cfd6e4;border-radius:999px;background:#fff;cursor:pointer;font-weight:600}
    .pill input{transform:scale(1.15)}
    .pill.active{border-color:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.15)}
    .partido-card{border:2px solid transparent;border-radius:12px;padding:14px;cursor:pointer;text-align:center;background:#fff}
    .partido-card:hover{border-color:#0d6efd;background:#f0f6ff}
    .partido-card.active{border-color:#0d6efd;background:#e7f1ff}
    .blank-card{border:2px dashed #d5dced;border-radius:12px;padding:14px;background:#fcfdff;display:flex;align-items:center;justify-content:space-between}
    .muted{color:#6b778c}
    .candidate-chip .chip{
      display:inline-flex;align-items:center;justify-content:center;
      width:42px;height:42px;border-radius:50%;border:1px solid #d0d7e2;
      font-weight:600;cursor:pointer;user-select:none;
    }
  </style>
</head>
<body>

<div class="header">
  <div class="d-flex align-items-center gap-3">
    <img src="img/logo_cne.png" alt="CNE" />
    <div class="lh-sm">
      <div style="font-size:.95rem">Rep√∫blica de Colombia</div>
      <div class="fw-bold">Sistema de Votaci√≥n a C√°mara de Representantes</div>
    </div>
  </div>
  <div class="fw-semibold">Votaciones</div>
</div>

<div class="container card-wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="fw-semibold">Estado de la jornada: <span class="badge bg-success">Abierta</span></div>
    <div id="horarioJornada" class="text-muted small"></div>
  </div>

  <!-- Identificaci√≥n -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Identificaci√≥n del votante</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Tipo de identificaci√≥n</label>
          <input class="form-control" disabled value="CC ‚Äì C√©dula de ciudadan√≠a">
        </div>
        <div class="col-md-6">
          <label class="form-label">N√∫mero de identificaci√≥n</label>
          <input id="numIdent" class="form-control" disabled>
        </div>
      </div>
    </div>
  </div>

  <!-- Modalidad -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Modalidad de voto</h5>
      <div id="modGroup" class="d-flex flex-wrap gap-2">
        <label class="pill active"><input type="radio" name="modalidad" value="territorial" checked>Territorial</label>
        <label class="pill"><input type="radio" name="modalidad" value="afro">Afrodescendiente</label>
        <label class="pill"><input type="radio" name="modalidad" value="indigena">Ind√≠gena</label>
      </div>
    </div>
  </div>

  <!-- Selecci√≥n -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="fw-bold fs-5">¬øPor cu√°l desea votar?</div>
          <div class="muted small">Seleccione un partido o elija voto en blanco</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <input id="buscador" class="form-control form-control-sm" style="width:260px" placeholder="Buscar partido o candidato...">
          <small id="contadorResultados" class="text-muted"></small>
        </div>
      </div>

<!--      <div class="blank-card my-3">
        <div><strong>Voto en blanco</strong><div class="muted small">Seleccione para votar en blanco</div></div>
        <input id="rbBlanco" type="radio" name="partido" class="form-check-input">
      </div>-->

      <div id="listaPartidos" class="row g-3"></div>
      <div id="msgSel" class="text-danger mt-2"></div>
    </div>
  </div>

  <!-- Confirmaci√≥n -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">Confirmaci√≥n</h5>
      <div class="mb-2"><strong>Su selecci√≥n:</strong> <span id="resumenSel" class="muted">‚Äî</span></div>
      <div class="form-check mb-3">
        <input id="chkDeclaracion" class="form-check-input" type="checkbox">
        <label for="chkDeclaracion" class="form-check-label">Declaro que mi voto es personal y secreto.</label>
      </div>
      <button id="btnVotar" class="btn btn-primary px-4" disabled>Confirmar voto</button>
    </div>
  </div>
</div>

<script>
const API_URL = "/api";

// ==== Sesi√≥n elector ====
let elector = null;
try { elector = JSON.parse(sessionStorage.getItem("elector") || "null"); } catch {}
if (!elector || !elector.id_elector) { window.location.assign("/"); }
document.getElementById("numIdent").value = elector.id_elector ?? "";

// Notificar que entr√≥ a la p√°gina de votaci√≥n (si existe el endpoint)
fetch(`/api/electores/${elector.id_elector}/status`).catch(()=>{});

// ==== Refs ====
const msgSel = document.getElementById("msgSel");
const listaPartidos = document.getElementById("listaPartidos");
const resumenSel = document.getElementById("resumenSel");
const btnVotar = document.getElementById("btnVotar");
const chkDeclaracion = document.getElementById("chkDeclaracion");
const rbBlanco = document.getElementById("rbBlanco");
const buscador = document.getElementById("buscador");
const contadorResultados = document.getElementById("contadorResultados");

// ==== Estado ====
// Mapa de circunscripciones por modalidad:
// - Territorial se llena consultando /circunscripciones?codigo_dane=<del elector>
// - Afro e Ind√≠gena usan los "departamentos inventados" y cod_cir fijos
const circMap = {
  territorial: null, // se completa con la consulta al backend
  afro: {
    cod_cir: 34,
    codigo_dane: 200,
    nombre: "Circunscripci√≥n Afrodescendiente"
  },
  indigena: {
    cod_cir: 35,
    codigo_dane: 300,
    nombre: "Circunscripci√≥n Ind√≠gena"
  }
};

const circNames = {
  territorial: "Territorial",
  afro: "Afrodescendiente",
  indigena: "Ind√≠gena"
};

let modalidadActual = "territorial";
let cod_cir = null;
let codigo_dane_circ = null;  // codigo_dane de la circunscripci√≥n actual
let partidosData = [];
let filtro = "";
let seleccion = null;
const candidatosCache = new Map(); // clave: `${cod_cir}:${cod_partido}`

// ==== Selecci√≥n persistente ====
function saveSel(sel){ if (sel) sessionStorage.setItem("seleccion_voto", JSON.stringify(sel)); }
function loadSel(){
  try { return JSON.parse(sessionStorage.getItem("seleccion_voto") || "null"); }
  catch { return null; }
}

// ==== Horario (solo visual) ====
(function(){
  const f = new Date();
  const dia = f.toLocaleDateString("es-CO",{day:"2-digit",month:"2-digit",year:"numeric"});
  document.getElementById("horarioJornada").textContent =
    `Desde ${dia}, 8:00 a.m. hasta ${dia}, 4:00 p.m.`;
})();

// ==== Helpers de nombres ====
function normalizeName(raw){
  return (raw||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
}
function isAfro(n){ return /\bafro|comunidades?\s+negras?|afrodesc/i.test(n); }
function isIndigena(n){ return /indigen/i.test(n); }
function isTerritorial(n){
  return /\bterritorial(es)?\b|ordinaria|general|departamental|departamento|distrital|distrito\b/i.test(n);
}

// ================================
//  CIRCUNSCRIPCIONES
// ================================
async function cargarCircunscripciones(){
  listaPartidos.innerHTML = "";
  partidosData = [];
  msgSel.textContent = "";

  let data = [];
  try {
    const res = await fetch(`${API_URL}/circunscripciones?codigo_dane=${elector.codigo_dane}`);
    if (res.ok) data = await res.json();
  } catch {
    data = [];
  }

  // Determinar circunscripci√≥n territorial para el departamento del elector
  if (Array.isArray(data) && data.length) {
    let terr = data.find(c => isTerritorial(normalizeName(c.nombre))) || data[0];
    circMap.territorial = {
      cod_cir: terr.cod_cir,
      codigo_dane: terr.codigo_dane ?? elector.codigo_dane,
      nombre: terr.nombre || "Territorial"
    };
  } else {
    // Fallback b√°sico si no responde nada
    circMap.territorial = {
      cod_cir: null,
      codigo_dane: elector.codigo_dane,
      nombre: "Territorial"
    };
  }

  // Modalidad actual seg√∫n radios
  const rb = document.querySelector('input[name="modalidad"]:checked');
  modalidadActual = rb ? rb.value : "territorial";

  const circSel = circMap[modalidadActual];
  cod_cir = circSel ? circSel.cod_cir : null;
  codigo_dane_circ = circSel ? circSel.codigo_dane : null;

  document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
  rb?.parentElement.classList.add("active");

  if (!cod_cir) {
    listaPartidos.innerHTML =
      `<div class="text-center text-secondary py-3">No hay partidos para esta modalidad.</div>`;
    return;
  }

  await cargarPartidos(codigo_dane_circ, cod_cir);
}

// ================================
//  PARTIDOS Y CANDIDATOS
// ================================
async function cargarPartidos(codigoDane, codCir){
  listaPartidos.innerHTML =
    `<div class="text-center text-secondary py-3">Cargando partidos...</div>`;

  // limpiar cach√© de otras circunscripciones
  [...candidatosCache.keys()].forEach(k=>{
    if (!k.startsWith(`${codCir}:`)) candidatosCache.delete(k);
  });

  let data = [];
  try {
    const res = await fetch(
      `${API_URL}/partidos?codigo_dane=${codigoDane}&cod_cir=${codCir}`
    );
    if (res.ok) data = await res.json();
  } catch {
    data = [];
  }

  partidosData = Array.isArray(data) ? data : [];
  await renderPartidos();
}

async function getCandidatos(codCir, codPartido){
  const key = `${codCir}:${codPartido}`;
  if (candidatosCache.has(key)) return candidatosCache.get(key);

  let arr = [];
  try {
    const res = await fetch(
      `${API_URL}/candidatos?codigo_dane=${codigo_dane_circ}&cod_cir=${codCir}&cod_partido=${codPartido}`
    );
    if (res.status === 204) {
      candidatosCache.set(key, []);
      return [];
    }
    const rows = await res.json();
    arr = Array.isArray(rows) ? rows : [];
  } catch {
    arr = [];
  }

  candidatosCache.set(key, arr);
  return arr;
}

// ================================
//  SELECCI√ìN Y RESUMEN
// ================================
function setSeleccion(obj){
  // {tipo, cod_cir, cod_partido?, num_lista?, nombre_partido?, nombre_candidato?, id_candidato?}
  seleccion = { ...obj };
  saveSel(seleccion);

  const circKey = Object.keys(circMap)
    .find(k => circMap[k] && circMap[k].cod_cir === seleccion.cod_cir);
  const circTxt = circNames[circKey] || "‚Äî";

  let resumen = "‚Äî";
  if (seleccion.tipo === "blanco") {
    resumen = `Voto en blanco ¬∑ Circ: ${circTxt}`;
  } else if (seleccion.tipo === "partido") {
    resumen = `${seleccion.nombre_partido || "Partido"} ¬∑ Circ: ${circTxt}`;
  } else if (seleccion.tipo === "candidato") {
    const nom = seleccion.nombre_candidato || "";
    const num = seleccion.num_lista ?? "‚Äî";
    resumen =
      `${nom ? nom+" ¬∑ " : ""}Tarjet√≥n #${num} ¬∑ ` +
      `${seleccion.nombre_partido || "Partido"} ¬∑ Circ: ${circTxt}`;
  }

  // üëá Esto es lo que ves en ‚ÄúSu selecci√≥n‚Äù
  resumenSel.textContent = resumen;

  // üëá El bot√≥n solo se habilita si hay selecci√≥n y la declaraci√≥n est√° marcada
  btnVotar.disabled = !(chkDeclaracion.checked && seleccion);
}
// =============================================
// ENGANCHE GEN√âRICO A RADIOS DE PARTIDO/CANDIDATO
// =============================================
document.addEventListener("change", (e) => {
  const t = e.target;

  // --- Selecci√≥n por PARTIDO ---
  if (t.matches('input[name="seleccion-partido"]')) {
    const card = t.closest(".partido-card");
    if (!card) return;

    limpiarSeleccionVisual();
    card.classList.add("active");
    rbBlanco.checked = false;

    const codPartido = Number(card.dataset.id);
    const nombrePartido = (card.querySelector(".fw-bold")?.textContent || "").trim();

    setSeleccion({
      tipo: "partido",
      cod_partido: codPartido,
      nombre_partido: nombrePartido,
      cod_cir: cod_cir
    });

    msgSel.textContent = "";
    return;
  }

  // --- Selecci√≥n por CANDIDATO ---
  if (t.matches('input[name="seleccion-candidato"]')) {
    const card = t.closest(".partido-card");
    if (!card) return;

    limpiarSeleccionVisual();
    card.classList.add("active");
    rbBlanco.checked = false;

    const chip = t.parentElement.querySelector(".chip");
    if (chip) {
      chip.style.border = "2px solid #0d6efd";
      chip.style.boxShadow = "0 0 0 2px rgba(13,110,253,.25)";
    }

    const codPartido = Number(t.dataset.cod);
    const idCandidato = Number(t.dataset.idcand);
    const numLista = Number(t.dataset.num);
    const nombrePartido = (card.querySelector(".fw-bold")?.textContent || "").trim();
    const nombreCandidato = t.parentElement.getAttribute("title") || "";

    setSeleccion({
      tipo: "candidato",
      cod_partido: codPartido,
      id_candidato: idCandidato,
      num_lista: numLista,
      nombre_candidato: nombreCandidato,
      nombre_partido: nombrePartido,
      cod_cir: cod_cir
    });

    msgSel.textContent = "";
  }
});


function limpiarSeleccionVisual(){
  document.querySelectorAll(".partido-card").forEach(el=>el.classList.remove("active"));
  document.querySelectorAll(".chip").forEach(ch=>{
    ch.style.border="1px solid #d0d7e2";
    ch.style.boxShadow="none";
  });
}

// ================================
//  B√öSQUEDA
// ================================
buscador?.addEventListener("input", async ()=>{
  filtro = buscador.value.trim().toLowerCase();
  await renderPartidos();
});

// ================================
//  RENDER PARTIDOS Y CANDIDATOS
// ================================
async function renderPartidos(){
  listaPartidos.innerHTML = "";
  let items = partidosData;

  // Filtro por nombre de partido o candidato
  if (filtro) {
    const out = [];
    for (const p of items) {
      const n = (p.nombre||"").toLowerCase();
      let ok = n.includes(filtro);
      if (!ok && (p.tipo_lista||"").toUpperCase()==="ABIERTA") {
        const cands = await getCandidatos(cod_cir, p.cod_partido);
        ok = cands.some(c =>
          String(c.num_lista||"").includes(filtro) ||
          (c.nombre||"").toLowerCase().includes(filtro)
        );
      }
      if (ok) out.push(p);
    }
    items = out;
  }

  contadorResultados.textContent =
    filtro
      ? (items.length ? `${items.length} resultado(s)` : "Sin coincidencias")
      : "";

  if (!items.length) {
    listaPartidos.innerHTML =
      `<div class="text-center text-secondary py-3">No hay partidos para mostrar.</div>`;
    return;
  }

  for (const p of items) {
    const tipo = (p.tipo_lista||"").toUpperCase();
    const col = document.createElement("div");
    col.className = "col-md-6";
    col.innerHTML = `
      <div class="partido-card p-3 border rounded mb-3" data-id="${p.cod_partido}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold">${p.nombre}</div>
            <div class="muted small">Lista ${tipo}</div>
          </div>
          <div>
            <label class="form-check-label me-2 small">Votar por el partido</label>
            <input type="radio" name="seleccion-partido" class="form-check-input">
          </div>
        </div>
        <div class="mt-3 candidatos-wrap"></div>
      </div>
    `;

    const card = col.querySelector(".partido-card");
    const rbPartido = col.querySelector('input[name="seleccion-partido"]');
    const candWrap = col.querySelector(".candidatos-wrap");

    // Voto por el partido (siempre disponible)
    rbPartido.addEventListener("change", ()=>{
      limpiarSeleccionVisual();
      card.classList.add("active");
      rbBlanco.checked = false;
      setSeleccion({
        tipo: "partido",
        cod_partido: p.cod_partido,
        nombre_partido: p.nombre,
        cod_cir: cod_cir
      });
      msgSel.textContent = "";
    });

    // Lista abierta ‚Üí render de candidatos
    if (tipo === "ABIERTA") {
      const candidatos = await getCandidatos(cod_cir, p.cod_partido);
      if (!candidatos.length) {
        candWrap.innerHTML = `<div class="text-muted small">Sin candidatos disponibles.</div>`;
      } else {
        candWrap.innerHTML = `
          <div class="d-flex flex-wrap gap-2">
            ${candidatos.map(c => {
              const rid = `cand-${p.cod_partido}-${c.num_lista}`;
              const nom = c.nombre || "";
              return `
                <label class="candidate-chip" title="${nom}">
                  <input
                    type="radio"
                    name="seleccion-candidato"
                    class="d-none"
                    id="${rid}"
                    data-cod="${p.cod_partido}"
                    data-idcand="${c.id_elector}"
                    data-num="${c.num_lista}"
                  >
                  <span class="chip" data-for="${rid}">${c.num_lista}</span>
                </label>
              `;
            }).join("")}
          </div>
        `;

        // Click en chip ‚Üí marca el radio
        candWrap.querySelectorAll('.chip[data-for]').forEach(chip=>{
          const rid = chip.getAttribute('data-for');
          const input = candWrap.querySelector(`#${CSS.escape(rid)}`);
          chip.style.cursor = "pointer";
          chip.addEventListener("click", ()=>{
            if (!input) return;
            input.checked = true;
            input.dispatchEvent(new Event("change", { bubbles:true }));
          });
        });

        candWrap.querySelectorAll('input[name="seleccion-candidato"]').forEach(rb => {
          rb.addEventListener("change", () => {
            limpiarSeleccionVisual();
            card.classList.add("active");
            const chip = rb.parentElement.querySelector(".chip");
            if (chip) {
              chip.style.border = "2px solid #0d6efd";
              chip.style.boxShadow = "0 0 0 2px rgba(13,110,253,.25)";
            }
            rbBlanco.checked = false;
            rbPartido.checked = false;

            setSeleccion({
              tipo: "candidato",
              cod_partido: Number(rb.dataset.cod),
              id_candidato: Number(rb.dataset.idcand),
              num_lista: Number(rb.dataset.num),
              nombre_candidato: rb.parentElement.getAttribute("title") || "",
              nombre_partido: p.nombre,
              cod_cir: cod_cir
            });
            msgSel.textContent = "";
          });
        });
      }
    }

    listaPartidos.appendChild(col);
  }
}

// ================================
//  VOTO EN BLANCO
// ================================
rbBlanco?.addEventListener("change", ()=>{
  if (rbBlanco.checked) {
    limpiarSeleccionVisual();
    setSeleccion({ tipo: "blanco", cod_cir });
    msgSel.textContent = "";
  }
});

// ================================
//  DECLARACI√ìN
// ================================
chkDeclaracion?.addEventListener("change", ()=>{
  btnVotar.disabled = !(chkDeclaracion.checked && seleccion);
});

// ================================
//  CONFIRMAR VOTO
// ================================
btnVotar?.addEventListener("click", async () => {
  if (!seleccion) {
    msgSel.textContent = "Seleccione un partido, candidato o voto en blanco.";
    return;
  }
  if (!chkDeclaracion.checked) {
    msgSel.textContent = "Debe aceptar la declaraci√≥n.";
    return;
  }

  const codCirEnviar = seleccion.cod_cir ?? cod_cir;

  // Usamos SIEMPRE el codigo_dane de la circunscripci√≥n, no el del elector
  const body = {
    id_elector: elector.id_elector,
    codigo_dane: codigo_dane_circ,
    cod_cir: codCirEnviar,
    cod_partido: (seleccion.tipo !== "blanco") ? seleccion.cod_partido : null,
    num_lista:   (seleccion.tipo === "candidato") ? seleccion.num_lista : null,
    id_candidato:(seleccion.tipo === "candidato") ? seleccion.id_candidato : null,
    voto_blanco: (seleccion.tipo === "blanco")
  };

  try {
    const res = await fetch(`${API_URL}/votar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    const data = await res.json().catch(()=> ({}));
    if (res.ok) {
      const cod = data.cod_vota || "";
      window.location.assign(`/confirmacion.html?cod_vota=${encodeURIComponent(cod)}`);
    } else {
      msgSel.classList.add("text-danger");
      msgSel.textContent = data.message || `Error al registrar voto (HTTP ${res.status}).`;
    }
  } catch (e) {
    console.error(e);
    msgSel.classList.add("text-danger");
    msgSel.textContent = "Error en la conexi√≥n con el servidor.";
  }
});

// ================================
//  BLOQUEO (2 minutos actualmente)
// ================================
(function controlarBloqueo() {
  const TIEMPO_MS = 2 * 60 * 1000;
  setTimeout(async () => {
    try {
      await fetch(`${API_URL}/electores/${elector.id_elector}/bloquear`, { method: "POST" });
    } catch (_) {}
    window.location.href = "/";
  }, TIEMPO_MS);
})();

// ================================
//  CAMBIO DE MODALIDAD
// ================================
document.querySelectorAll('input[name="modalidad"]').forEach(rb=>{
  rb.addEventListener("change", async ()=>{
    document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
    rb.parentElement.classList.add("active");
    modalidadActual = rb.value;

    const circSel = circMap[modalidadActual];
    cod_cir = circSel ? circSel.cod_cir : null;
    codigo_dane_circ = circSel ? circSel.codigo_dane : null;

    filtro = "";
    if (buscador) buscador.value = "";
    candidatosCache.clear();

    if (!cod_cir) {
      listaPartidos.innerHTML =
        `<div class="text-center text-secondary py-3">No hay partidos para esta modalidad.</div>`;
      return;
    }

    await cargarPartidos(codigo_dane_circ, cod_cir);

    const prev = loadSel();
    if (prev && prev.cod_cir === cod_cir) setSeleccion(prev);
    else btnVotar.disabled = !(chkDeclaracion.checked && seleccion);
  });
});

// ================================
//  INICIO
// ================================
(async ()=>{
  await cargarCircunscripciones();
  const prev = loadSel();
  if (prev) setSeleccion(prev);
})();
</script>

</body>
</html>
